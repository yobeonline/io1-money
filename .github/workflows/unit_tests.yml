name: unit tests
on: [push]

jobs:
  unit-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        config: [Release, Debug]
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v2

      - name: Get latest cmake
        uses: lukka/get-cmake@latest
        
      - name: Configure
        shell: cmake -P {0}
        run: |
          if ("${{ matrix.os }}" STREQUAL "windows-latest")
            set(vcpkg_triplet x64-windows)
            set(compiler_flags "/EHsc /W4")
          else()
            set(vcpkg_triplet x64-linux)
            set(compiler_flags "-Wall -Wextra -Wpedantic -Wconversion -Wshadow")
            set(ENV{CC} "gcc-13")
            set(ENV{CXX} "g++-13")
          endif()
          execute_process(
            COMMAND cmake
              -S .
              -B build
              -D CMAKE_BUILD_TYPE=${{ matrix.config}}
              -D VCPKG_TARGET_TRIPLET=${vcpkg_triplet}
              -D "CMAKE_C_FLAGS=${compiler_flags}"
              -D "CMAKE_CXX_FLAGS=${compiler_flags}"
              --toolchain="$ENV{VCPKG_INSTALLATION_ROOT}/scripts/buildsystems/vcpkg.cmake"
            RESULT_VARIABLE result
          )
          if (NOT result EQUAL 0)
            message(FATAL_ERROR "Bad exit status")
          endif()

      - name: Build
        run: cmake --build build --config ${{ matrix.config }} --parallel

      - name: Execute
        run: ctest --test-dir build -C ${{ matrix.config }}

      - name: Publish test report
        uses: mikepenz/action-junit-report@v3
        with:
          report_paths: 'build/bin/junit_*.xml'